 <span id="mulu"></span>

# 场景              

[1. 房间系统](#1)  
 
[2. 房间](#2)  
 
[3. 传送点](#3) 
 
[4. 传送序列](#4) 

[5. 过渡](#5) 

[6. 2D遮罩](#6) 

[7. Cinemachine Zones](#7) 

<p id="1"></p>              

## 1. 房间系统
 
在很长一段时间里，TopDown Engine提供了将不同场景连接在一起的能力，或使用传送器将关卡的各个部分连接在一起。随着v1.8, TopDown引擎现在配备了一个强大和通用的房间系统。这让你能够将一个关卡分割成“房间”(游戏邦注:不管它们在视觉上是真正的房间还是区域，都取决于你)，并使用Teleporter类将这些房间连接在一起(游戏邦注:这些Teleporter在视觉上是否表现为门、门户、什么都不是，或者其他任何东西，都取决于你)。它利用Unity的Cinemachine摄像机系统的力量来处理房间之间的摄像机转换，以及一些MoreMountains类来处理淡化和精灵蒙版。本页面解释了如何做到这一点，并涵盖了客房系统的其他功能和选项。

KoalaRooms的演示场景便是这一系统的完美例子，它展示了许多房间以及设置传送器的不同方法。你也可以查看MinimalRooms3D演示场景，以了解如何在3D中设置房间
 
[返回目录](#mulu)

<p id="2"></p>              

## 2. 房间系统
 
首先，你需要在关卡中创造房间。无论你的关卡是由贴图、2D精灵还是3D模型构成，这都不重要。要创建一个房间，只需创建一个新的空对象，如果你是在2D环境中添加一个BoxCollider2D，如果你是在3D环境中添加一个BoxCollider，以及一个房间组件。调整碰撞器的大小，使其与你的房间的大小相匹配，并设置isTrigger:true。

嵌套在房间下面，作为孩子，你需要添加:

一个限制:一个空的游戏对象，带有一个BoxCollider。

一个 Cinemachine虚拟相机。在这个相机上，你可能需要一个CinemachineCameraController和一个CinemachineConfiner(点击CinemachineVirtualCamera组件底部的“添加扩展”按钮)。在CinemachineConfiner的检查器上，你需要将限制模式设置为Confine3D，并将你刚刚创建的限制拖动到边界卷槽中。在2D中，你可能还需要选择限制屏幕边缘。

一个或多个传送者(我们会讲到的)
 
  ![示例图片](/images/rooms-1.png)

Room类负责在Start时动态调整围限以匹配摄像机大小(仅在2D中)，跟踪其状态(访问或未访问)，并在玩家进入、退出或首次进入房间时触发事件。

一旦你创建了一个房间，添加更多内容的最佳方法便是复制它，重新定位它并调整其碰撞器的大小以创造出更多内容。确保为它们提供唯一的名称。虽然不是强制性的，但这将使以后更容易找到他们

[返回目录](#mulu)


<p id="3"></p>              

## 3. 传送点
 
现在您已经有了多个房间，是时候添加从一个房间到另一个房间的方法了。这是使用传送器类和它的许多选项来完成的。

  ![示例图片](/images/rooms-2.png)

首先，在你的房间中添加一个空的游戏对象，添加BoxCollider2D(在2D中)或BoxCollider(在3D中)(IsTrigger设置为true)，并添加一个Teleporter脚本。传送者有很多选择。您可以定义激活需求、激活条件、激活量、提示、输入、反馈等等。对于房间之间的门，也许你只需要将AutoActivation设置为true，以便进入碰撞器的任何字符被移动到新房间。

传送特定的字段在检查器的底部(顶部是所有按钮激活区域的公共区域)。

  ![示例图片](/images/rooms-3.png)
 
 他唯一强制设置的东西将是目的地，在那里你将不得不拖放另一个传送者，以及目标房间，在那里你将需要拖放一个目的地房间。

在传送部分，你可以决定传送是否只影响玩家角色，退出偏移(当有东西退出时添加到传送器的转换位置)，传送应该是即时的还是在进入和退出位置之间的过渡，以及x或y位置是否应该保持。

冻结部分让你选择是否你想要传送者冻结时间和/或角色进入它。

在Rooms部分中，如果Teleporter嵌套在Room下面，则不需要设置CurrentRoom，它将被自动检测到。您有不同的相机模式选项，Cinemachine优先级是推荐的一个

[返回目录](#mulu)


<p id="4"></p>              

## 4. 传送序列
 
当进入传送器并激活它时(通过按下一个输入，或通过简单地进入它，或通过脚本，这取决于你的设置)，你会触发一系列被称为传送器序列的事件。它被设计成尽可能可定制，并且易于扩展。它由几个步骤组成，它们的持续时间(以秒为单位)你可以在传送器的检查器底部自定义。

  ![示例图片](/images/rooms-4.png)

###  默认情况下，步骤如下(注意，不是每个步骤的所有事件都可能发生，这取决于你的设置):

    SequenceStart:激活区域(减少使用计数器，触发反馈，等)，防止相机跟踪，冻结时间，冻结角色

    等待InitialDelay

    AfterInitialDelay:通过MMFader淡出场景

    等待FadeOutDuration

    后淡出:传送物体，可以是瞬间传送，也可以是开始一个平滑的位置渐变，开始镜头转换，让当前房间知道玩家已经离开，开始蒙版转换

    等待DelayBetweenFades

    afterdelaybetweenfade:让镜头再次跟随，通过MMFader淡入场景

    等待FadeInDuration

    淡入后:暂时没有

    等待FinalDelay

    SequenceEnd:解冻时间和角色

每一步都是一个单独的方法，如果您想添加更多的特性，您可以很容易地覆盖它。
 
[返回目录](#mulu)


<p id="5"></p>              

## 5. 过渡
 
  ![示例图片](/images/rooms-5.png)
 
 传送器的检查器让你检查当你转换到目的地时是否想要触发淡出。这反过来将触发MMFadeEvent，它将被场景中的MMFader对象捕获，如果你有一个。大多数演示场景都会这样做，通常在它们的UICamera对象中。默认情况下，引擎有两个渐变器，经典的MMFader(它将渐变一个UI元素的不透明度-通常是一个横跨整个屏幕的黑色不透明精灵，但不一定)，和MMFaderRound，它将应用一个遮罩过渡在一个UI元素

[返回目录](#mulu)

<p id="6"></p>              

## 6. 2D遮罩
 
  ![示例图片](/images/rooms-5.png)
 
通常在2D游戏中，当你在关卡中处理多个房间时，你会想要模糊玩家在特定时间并未进入的房间。当然，你决定怎么做与你的渲染选择密切相关。虽然这是有点无用的尝试和提供一个3D解决方案，因为它可能会混乱你的特定着色器，引擎附带一个2D解决方案的问题:MMSpriteMask。你可以从头开始创建一个，或者简单地复制KoalaRooms演示中的一个，它已经准备好使用了。

在它的检查器上，你可以让它在开始时自动设置场景中的所有渲染器(这很有用，否则它实际上会掩盖场景视图中的东西，使关卡版本更棘手)。如果你想让一个对象在运行时被蒙版忽略，只需在它上面放一个NoMask标签

[返回目录](#mulu)

<p id="7"></p>              

## 7. Cinemachine Zones
 
如果你想要复杂的交互和对过渡的大量控制，那么上面描述的Rooms系统非常棒。但有时你可能只是渴望一些简单的东西。这时候，top - down Engine的Cinemachine Zones便出现了。

  ![示例图片](/images/rooms-5.png)

它们将让你将关卡划分为多个部分(游戏邦注:由对撞机定义，所以它们可以根据你的需要进行塑造和定位)。当玩家(或任何你定义的物体/层)进入一个区域时，摄像机将发生转换。最棒的是区域设置是尽可能自动化的，设置整个关卡只需要几次点击。


你可以在2D的KoalaCinemachineZones演示场景中找到这个系统的参考，在3D的Colonel演示场景中找到这个系统的例子。创建一个区域非常简单，以下是你需要做的所有事情:

在这个例子中，我们将在KoalaCinemachineZones中工作，为此我们将禁用所有现有的CinemachineZones。您可以根据自己的情况随意调整尺寸和位置。

    打开KoalaCinemachineZones演示场景

    在它的层次结构中选择CinemachineZones对象并禁用它

    创建一个新的空游戏对象，命名为MyZone1，将其定位在- 15,4,0

    添加一个BoxCollider2D到它，设置其大小为32,32

    添加TopDownCinemachineZone2D到它，设置CameraStartsActive:true

    在层级结构的KoalaCameras节点下，你会发现一个“CM vcam1”对象。复制它，并将它移动到MyZone1对象下，重命名为VirtualCamera，并启用它(复制它时应该是禁用的)

    拖动VirtualCamera对象到MyZone1的TopDownCinemachineZone2D的虚拟相机插槽，并在TriggerMask下拉菜单中，选择Player，因为我们希望区域在玩家进入时激活。设置SetupConfinerOnStart:真的。

    按下播放键，你的相机将被限制在那个区域内

    退出播放模式，复制MyZone1，命名为新对象MyZone2，移动到15，-4,0，设置CameraStartsActive:false

    就这样，您已经设置好了前两个房间，祝贺!

    注意在每个区域的检查器底部，你可以改变区域的小发明的颜色，选择一个你喜欢的

    你现在可以添加更多区域来覆盖你的整个关卡，你想怎么布置就怎么布置

    如果你想在区域之间调整相机的转换，那将在你的相机上的CinemachineBrain(在这种情况下，在MinimalCameraRig下的常规相机对象)。您将希望更改DefaultBlend及其关联的持续时间。

    在每个虚拟相机上，你可以有完全不同的设置，请随意尝试!

[返回目录](#mulu)